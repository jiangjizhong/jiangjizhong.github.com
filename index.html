<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: ''
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="姜太公的记事本">
<meta property="og:url" content="http://oditszapc.com/index.html">
<meta property="og:site_name" content="姜太公的记事本">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="姜太公的记事本">
  <link rel="canonical" href="http://oditszapc.com/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>姜太公的记事本</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  <div class="container sidebar-position-left page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">姜太公的记事本</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Categories</a>

  </li>
    </ul>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/07/02/java-unit-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/07/02/java-unit-test/" class="post-title-link" itemprop="url">关于单元测试</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2013-07-02T00:00:00+08:00">2013-07-02</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:06:41" itemprop="dateModified" datetime="2019-08-03T17:06:41+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/development/" itemprop="url" rel="index"><span itemprop="name">软件开发</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>在公司里，关于单元测试的话题，每两个月就要来一次小的，每年就要来一次大的，虽然频率比月经低，但是讨厌的程度丝毫不亚于后者（虽然我是男的）。</p>
<p>一般的节奏是这样的：过程改进部门（忘了那个神奇的部门叫什么名字了）新来的一个家伙，所谓新官上任三把火，就算是为了绩效考核也得做点什么吧，最简单并且能出成绩的当然是搞单元测试，因为每个项目每个产品的单元测试都烂的一塌糊涂或者根本没有单元测试。于是这位很快的给出了单元测试代码覆盖率85%的指标，并且任务下发到各个小部门，苦逼的开发开始吭吃吭吃的开始补写单元测试，但是这些苦逼的开发平时的工作都要加班完成，哪还有闲情逸致慢慢写单元测试，只能想方设法的搞定覆盖率，完全不管是否真的起到了测试的作用（最坑爹的情况是单元测试里看不到一个assert），运行，绿色！</p>
<p>就这样，苦逼的开发补完了单元测试，达到了85%的覆盖率，负责过程改进的家伙完成了自己的绩效，皆大欢喜。一段时间之后，数据库的数据开始乱掉了，很多单元测试变红了，有些代码修改了，对应的单元测试却没有修改，渐渐的，又回到的最初的状态，直到下一个负责过程改进的家伙来了。</p>
<h2 id="为什么要写单元测试"><a href="#为什么要写单元测试" class="headerlink" title="为什么要写单元测试"></a>为什么要写单元测试</h2><p>在单元测试这个话题上，我只是一个菜鸟，是在不敢胡乱发表什么观点。Google上能搜到很多“为什么要写单元测试”的文章，我比较赞同的有下面两个观点</p>
<ol>
<li>单元测试可以尽早的发现bug<br>在开发过程中，越早发现问题，解决所要付出的代价越小。在单元测试期间发现bug，定位和修复都比较简单，修改后验证也很容易，不像集成测试要搭建复杂的环境，修复一个bug就要浪费很多时间。</li>
<li>作为重构的质量保证<br>如果有单元测试，对代码重构后只要简单的运行一遍单元测试，就能知道重构是否引入了bug，这对单元测试是有要求的，后面会提到。</li>
</ol>
<h2 id="问题在哪里"><a href="#问题在哪里" class="headerlink" title="问题在哪里"></a>问题在哪里</h2><p>开头的真实故事里，问题的根源在单元测试的质量，由于太多的外部依赖，只要稍有一点配置不对，单元测试就没法通过，运行成功单元测试本身就成了一件困难重重的任务，除了写单元测试的时候，没有人愿意运行单元测试，即使修改了代码也不愿意管它，单元测试成了摆设。代码修改，单元测试却从来不改，最终完全腐烂了。</p>
<h2 id="该怎么写单元测试"><a href="#该怎么写单元测试" class="headerlink" title="该怎么写单元测试"></a>该怎么写单元测试</h2><p>对于如何写单元测试，在网络上能看到的都是一些理论的东西，诸如“要Mock所有的依赖”、“AAA”，偶尔举个例子，也是对一个很简单场景下很简单的类写单元测试，完全没见过真正有用的。</p>
<p>对应”为什么要写单元测试”，个人认为写单元测试分为两个层面：</p>
<ol>
<li>验证代码正确性<br>这是常规意义上“测试”所要求的部分，要设计各种测试用例、考虑边界条件，然后写成单元测试即可，这个比较简单，也是基本要求。</li>
<li>作为重构的依据<br>这是对单元测试“可维护性”方面的要求，单元测试必需能很容易运行而不需要预先大量的配置，不能有太多的外部依赖，所有这样的依赖都应该MOCK。</li>
</ol>
<p>写单元测试的重点，就在于考虑其“可维护性”。在具体实践上会比较灵活，肯定不会像某些鼓吹单元测试的人所说MOCK全部依赖，即使有jmockit、easymock之类的工具，mock依然是件很繁琐事情，尤其是依赖比较多的时候，单元测试里将充满mock代码，真正的测试代码反而只占小部分。我个人的习惯是，外部的不可控的就mock，比如数据库、网络，完全自己实现的逻辑可以不用mock，比如一个纯算法的类。</p>
<h2 id="为什么一直说覆盖率"><a href="#为什么一直说覆盖率" class="headerlink" title="为什么一直说覆盖率"></a>为什么一直说覆盖率</h2><p>为什么单元测试的考核指标总是覆盖率？我个人的猜测是，对于负责过程改进的那个家伙和QA，覆盖率是他们唯一能看到并且可量化的指标，毕竟单元测试不像功能代码，没做相应的功能就体现不出来。但是，覆盖率显然不是一个评价单元测试质量的好指标。</p>
<p>如果真要找出一种保证单元测试质量的办法，我觉得Code Review还真不错，我们一直都用它保证我们功能代码。</p>
<h2 id="代价"><a href="#代价" class="headerlink" title="代价"></a>代价</h2><p>无论是写单元测试，还是维护单元测试代码，都是有成本的，所以做到什么程度，又是另外一个要权衡的问题了。</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/04/25/bash-array-expansion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/04/25/bash-array-expansion/" class="post-title-link" itemprop="url">Bash中数组的扩展</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-04-25 00:00:00" itemprop="dateCreated datePublished" datetime="2013-04-25T00:00:00+08:00">2013-04-25</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:08:59" itemprop="dateModified" datetime="2019-08-03T17:08:59+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/language/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>在Bash里，数组的扩展很坑爹，虽然数组的出镜率很低（除了特殊变量<code>$@</code>和<code>$*</code>，我没有用过数组）。假设有以下脚本outer：</p>
<pre><code>#out.sh
./inner &quot;a $@ b&quot;</code></pre><p>调用<code>outer 1 2</code>, 请问inner收到几个参数，分别是什么？如果你完全不知道怎么回答，可以先看看我原来写的一篇文章<a href="http://jjz.iteye.com/blog/388946" target="_blank" rel="noopener">Shell命令中的扩展和替换</a>，如果你回答1个，那可以接着往下看。</p>
<p>Bash中当引用数组全部元素的时候，有两种方式：<code>${array[@]}</code>和<code>${array[*]}</code>，通常情况下，两种方式是一样的，但是……当数组出现在双引号内部时，就有所区别区别了：<code>$array{*}</code>会扩展成一个字符串，字符串的内容是以IFS首个字母（一般就是空格）为分隔把数组的元素连在一起。为了便于理解，我们先创建两个脚本文件outer.sh和inner.sh，内容如下</p>
<pre><code>#outer.sh
#!/bin/bash
./inner &quot;$*&quot;

#inner.sh
#!/bin/bash
for arg
do
    echo &quot;[$arg]&quot;
done</code></pre><p>然后运行： <code>./outer.sh 1 2 3</code>，输出 <code>[1 2 3]</code>，显然，inner.sh只收到1个参数。</p>
<p><code>$array[@]</code>会扩展成多个字符串，字符串的数量就是数组的长度。 把outer.sh里的<code>$*</code>换成<code>$@</code>，再运行，输出</p>
<pre><code>[1]
[2]
[3]</code></pre><p>inner.sh收到三个参数。以上，稍微用过Bash的同学应该都知道，之所以写这么多完全是显着无聊凑字数。</p>
<p>下面说说真正坑爹的。当出现诸如<code>&quot;prefix $array[@] suffix&quot;</code>的情况时，也就是<code>$array[@]</code>出现在双引号里面并且前后还有字符串，会扩展成什么呢？答案是：会扩展成多个字符串，数量就是数组的长度，但是：** 第一个字符串是prefix加上数组的第一个元素，最后一个字符串是数组的最后一个元素加上suffix **，把outer.sh改成这样</p>
<pre><code>#!/bin/bash

./inner &quot;prefix $@ suffix&quot;</code></pre><p>运行<code>./outer.sh 1 2 3</code>,输出</p>
<pre><code>[prefix 1]
[2]
[3 suffix]</code></pre><p>这种行为完全不符合常理啊！</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/04/19/java-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/04/19/java-socket/" class="post-title-link" itemprop="url">Java Socket的一些常见问题</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-04-19 00:00:00" itemprop="dateCreated datePublished" datetime="2013-04-19T00:00:00+08:00">2013-04-19</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:06:10" itemprop="dateModified" datetime="2019-08-03T17:06:10+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>最后一篇博客到现在已经快两个月了，果然还是太懒，总是不愿意写点东西，有什么办法能治好吗？ 好吧，不废话，进入正题。</p>
<p>用Java写网络程序，大部分时间都很好，所有的东西都封装了，简单，方便，无需处理大量的细节问题，看上去很完美。可惜一旦出现问题，就很难排查，封装的太厚了，而且所有的错误全部用IOException或者SocketException的方式抛出，加上一些怪异的信息，比如Connection reset，完全不知道到底错误原因是什么。网络通信本身并不复杂，无非就是发送数据包，接收数据包。以最常用的TCP为例，其核心也无非就是可靠传输加上拥塞控制，而可靠传输的精华就是确认和重传，很简单不是吗。</p>
<p>再看看linux的socket，比如connect，所有的错误都有明确的errorcode，一看就知道发生了什么错误。</p>
<h2 id="socket和数据包"><a href="#socket和数据包" class="headerlink" title="socket和数据包"></a>socket和数据包</h2><p>之所以要先说socket，因为这是基础，了解了这个才能真正了解Java Socket里那些提示信息，如果根本不懂tcp，不懂socket，直接处理Java网络编程，也只能是浅浅的留在表面，不得深入。</p>
<pre><code>socket s = socket()
s.connect(ip, port)
s.send(&apos;data&apos;)
s.recv()
s.close()</code></pre><p>这是一段简单的伪代码，描述客户端tcp socket建立连接和发送、接收数据，大部分语言都是类似的写法。那么，每一步可能会发生什么错误呢？我们一点点来分析。当然，忽略一些本地错误，比如没权限建socket之类的，只分析网络交互上的错误。</p>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>在connect里，常见的错误有两个：Connection refused和Connection Timeout。众所周知，tcp建立连接需要三次握手，读者可以自己Google下“tcp 三次握手”的图片，一看就能明白这个过程。</p>
<p>在这个过程中，如果客户端发送SYN包，服务器返回了RST包，这表明在服务器上，没有服务监听客户端要访问的端口，在Unix上，connect系统调用直接返回ECONNREFUSED，也就是连接拒绝。(RST全称reset，三种情况下会产生RST：1. SYN达到某端口，但没有监听这个端口的服务；2. TCP想取消一个已有的连接；3. TCP收到一个根本不存在的连接上的数据包)。</p>
<p>另外，路由器可能会返回一个目的不可达的ICMP包，Unix上，connect系统调用直接返回ENETUNREACH，这种情况下connect会重试，重新发送SYN，重试一段时间依然不行才会返回ENETUNREACH.</p>
<p>最后一种情况是，过了一段时间，客户端根本没收到任何响应的数据包，connect系统调用返回ETIMEOUT，也就是连接超时。</p>
<p>使用Java的时候，第一种情况抛出java.net.ConnectException: Connection refused. 第二和第三种情况都会在等很久出现java.net.ConnectException: Connection timed out，但其实导致问题的原因不一样。</p>
<p>Java在调用connect时可以指定超时，这点比connect系统调用好，后者没法直接设置超时。</p>
<h3 id="send"><a href="#send" class="headerlink" title="send"></a>send</h3><p>在send里可能发生的错误有超时和Connection reset。先说第一种情况，了解tcp的都知道，tcp发送了数据后要等对方确认，如果对方一直没有发送确认消息，发送方会一直重试，当然，实际上采用的是“指数退避”算法，不过我们不关心这个，只要知道发送了没确认tcp会一直重试，直到达到一定次数为止。然后就超时了。</p>
<p>另一种情况是对方关闭了socket，主动close或者crash了，这边还在send，对方服务器返回RST包，在Unix上，send系统调用返回ECONNRESET，错误信息时Connection reset by peer。 用Java也差不多，错误是java.net.SocketException: Connection reset。</p>
<h3 id="recv"><a href="#recv" class="headerlink" title="recv"></a>recv</h3><p>读取对方的数据，最常见的错误是超时，及其偶然的情况下，出现Connection rest。我唯一能想到的出现Connection reset的情况是这样的：本机阻塞在read或者recv上，对方关闭了连接，但本机没有收到FIN（在模拟这个问题是，我用iptable丢掉了FIN包），在开启了keepalive的情况下，本机过一段时间会发送keepalive的探测包（<code>/proc/sys/net/ipv4/tcp_keepalive_time</code>），可以用netstat -to查看tcp相关的定时器，对方返回RST，出现Connection reset。也有可能对方没有任何响应（比如对方直接拔掉网线，本机也会收不到FIN，同样，所有的探测包也没有响应），探测几次后本机超时。</p>
<h2 id="close"><a href="#close" class="headerlink" title="close"></a>close</h2><p>受到linger选项的影响，在Java里很少出问题，先不说这个了。</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/02/24/access-database-in-shell-script/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/02/24/access-database-in-shell-script/" class="post-title-link" itemprop="url">在Shell脚本里访问数据库</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2013-02-24T00:00:00+08:00">2013-02-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:08:41" itemprop="dateModified" datetime="2019-08-03T17:08:41+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/language/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>在Shell脚本里也可以读写数据，而且很简单。</p>
<pre><code>echo select * from table | mysql -h host -u user -ppassword schema </code></pre><p>就是这么简单，如果语句比较多，还可以使用here document</p>
<pre><code>mysql -h host -u user -ppassword schema &lt;&lt;- END
    select * from table1
    insert into ....
END</code></pre><p>同样的道理，ftp也可以这样做，或者说，只要程序从标准输入读取，都可以这样做。对于有些程序，比如ssh，它并非从标准输入读取，这是就要用expect了。参见 (expect简明教程)[  ]</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/02/24/how-to-launch-only-one-script-instance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/02/24/how-to-launch-only-one-script-instance/" class="post-title-link" itemprop="url">如何只启动一个Shell脚本的实例</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2013-02-24T00:00:00+08:00">2013-02-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:08:49" itemprop="dateModified" datetime="2019-08-03T17:08:49+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/language/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>写脚本时，一个很常见的需求就是只允许启动一个实例，比如我们要在脚本中往文件里写数据，同时启动此脚本的两个进程就把文件内容写坏了，只能启动一个进程。本质上，脚本要在启动的时候检测是否已经启动了此脚本的另一个进程，如果已经启动，当前进程应该退出。</p>
<h2 id="判断文件是否存在"><a href="#判断文件是否存在" class="headerlink" title="判断文件是否存在"></a>判断文件是否存在</h2><p>最简单的方式是采用“锁”文件，这个文件存在表示另外一个进程已经存在，当前进程退出，否则创建锁文件并且继续执行。<br>    if [ -f lock_file ]; then<br>        exit 1<br>    fi<br>    touch lock_file</p>
<p>这种方法比较简单，也有不少缺陷</p>
<ol>
<li>存在并发问题。某个时间点，进程1检测到没有文件，进程2也检测到没有文件，1创建文件继续执行，2也创建文件继续执行。出现了两个进程。</li>
<li>如果进程意外退出，没有清理锁文件，后续的启动都会失败。</li>
</ol>
<h2 id="pid文件"><a href="#pid文件" class="headerlink" title="pid文件"></a>pid文件</h2><p>方案1的改进是采用pid文件，进程会创建一个pid文件，内容是自己的pid。进程启动时会检测pid文件，如果pid文件存在并且其中的pid在运行，则退出，否则创建pid文件并且写入自己的pid，继续执行。</p>
<pre><code>if [ -f pid_file ] &amp;&amp; [ -d /proc/$(cat pid_file) ]; then
    exit 
fi

echo $$ &gt; $pid_file</code></pre><p>这个方案解决了方案1的第二个问题，依然存在并发问题：可能两个同时启动的进程都检测到不存在pid文件对应的进程，然后创建pid文件并且写入自己的pid。</p>
<h2 id="用ps命令查看当前脚本是否在运行中"><a href="#用ps命令查看当前脚本是否在运行中" class="headerlink" title="用ps命令查看当前脚本是否在运行中"></a>用ps命令查看当前脚本是否在运行中</h2><pre><code>script_name=$(basename $0)
proc_count=$(ps --no-headers -C &quot;$script_name&quot;|wc -l)
if ((proc_count &gt;= 3)); then
    exit 1
fi</code></pre><p>需要注意的是，ps对于文件名的处理有限制，只能在15个字符内，所以对于脚本名hhhhhhhhhhhhhhh1和hhhhhhhhhhhhhhh2，ps -C是无法区分的。这种方法看似很靠谱，可惜的是</p>
<ol>
<li>这种方法在不同的平台上会有不同的结果，有时候是2,有时候是3,甚至在同一个系统上多运行几次都可能得到不同的值。</li>
<li>如果两个脚本同时启动并且检测进程数量，会发现进程数是3,两个都退出了。</li>
</ol>
<h2 id="采用flock"><a href="#采用flock" class="headerlink" title="采用flock"></a>采用flock</h2><p><code>flock -n lock\_file real\_script</code>，在外部用flock调用实际的脚本。或者在脚本里这样写</p>
<pre><code>(
    flock -u 100 || exit 1
    #other 
) 100&gt;lock\_file</code></pre><p>这种方式是以上几种方式中比较完美的。</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/02/23/limit-bandwidth-by-user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/02/23/limit-bandwidth-by-user/" class="post-title-link" itemprop="url">Linux上限制用户的带宽</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-02-23 00:00:00" itemprop="dateCreated datePublished" datetime="2013-02-23T00:00:00+08:00">2013-02-23</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:05:21" itemprop="dateModified" datetime="2019-08-03T17:05:21+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>最近有个需求，一台机器上有多个用户，有些用户要多分配一些网络带宽，另外一些用户少分配一些（万恶的等级制度啊！）。既然有这个需求，那就做吧。首先果断祭起Google，大概了解到，Linux下流量控制基本上只有tc这一个，配合iptables还是可以搞定这个需求的。</p>
<p>TC的全称是Traffic Control，也就是流量控制，是iproute2中的一部分。实际上它只能控制本机发出去的流量，对于发往本机的流量，它是控制不了的。更多TC的信息，请看这个(PDF)[<a href="http://lartc.org/LARTC-zh_CN.GB2312.pdf]。" target="_blank" rel="noopener">http://lartc.org/LARTC-zh_CN.GB2312.pdf]。</a></p>
<p>iptables就更不用说了，不知道iptables你还好意思做程序员？</p>
<p>看了看tc的文档，显然要选择htb队列规定，完美满足需求。总带宽是100Mbit，vip组用户共享80Mbit，普通用户组共享20Mbit.</p>
<p>废话不多说了，直接上代码。</p>
<pre><code>INTERFACE=eth0
tc qdisc add dev $INTERFACE root handle 1: htb default 10
tc class add dev $INTERFACE parent 1: classid 1:1 htb rate 100mbit
tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate 1kbps ceil 80mbit  #不在普通用户组和vip用户组，分配1k的带宽，但是可以借用最高80m的带宽。
tc class add dev $INTERFACE parent 1:1 classid 1:20 htb rate 80mbps ceil 90mbit  # vip用户组分配80m带宽
tc class add dev $INTERFACE parent 1:1 classid 1:30 htb rate 20mbps ceil 90mbit  # 普通用户组分配20m带宽

#iptables的配置
iptables -t mangle -A POSTROUTING -m owner --gid-owner $vip_id -j CLASSIFY --set-class 1:20
iptables -t mangle -A POSTROUTING -m owner --gid-owner $normal_id -j CLASSIFY --set-class 1:20</code></pre><p>搞定！</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/02/13/iptables-on-opensuse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/02/13/iptables-on-opensuse/" class="post-title-link" itemprop="url">修改openSUSE的iptables规则</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-02-13 00:00:00" itemprop="dateCreated datePublished" datetime="2013-02-13T00:00:00+08:00">2013-02-13</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:05:11" itemprop="dateModified" datetime="2019-08-03T17:05:11+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>openSUSE安装后就自动设置了一堆的iptables规则，默认情况下，端口22没有开放出来，总不能每次都手工添加一条规则吧。下面说说怎么添加新的规则。</p>
<p>打开/etc/sysconfig/SuSEfirewall2这个文件，这是一个配置文件，搜索<code>FW_CUSTOMRULES</code>，你看到的应该是<code>FW_CUSTOMRULES=&quot;&quot;</code>，没错了，把它改成<code>FW_CUSTOMRULES=&quot;/etc/sysconfig/scripts/SuSEfirewall2-custom&quot;</code>，意思是用户自定义的配置放在<code>/etc/sysconfig/scripts/SuSEfirewall2-custom</code>这个文件里。</p>
<p><code>/etc/sysconfig/scripts/SuSEfirewall2-custom</code>这个文件其实是系统自带的，打开这个文件会看到里面定义了三个函数，不过都是空函数。对于要打开22端口这样的需求，我们修改<code>fw_custom_after_chain_creation</code>函数，在里面加一行 </p>
<pre><code>iptables -A input_ext -p tcp --dport 22 -j ACCEPT</code></pre><p>保存后别忘了执行 <code>sudo /sbin/SuSEfirewall2</code>让新规则生效。</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/02/13/Cgroups/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/02/13/Cgroups/" class="post-title-link" itemprop="url">cgroups简介</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-02-13 00:00:00" itemprop="dateCreated datePublished" datetime="2013-02-13T00:00:00+08:00">2013-02-13</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:05:00" itemprop="dateModified" datetime="2019-08-03T17:05:00+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>cgroups(Control Group)是Linux内核的功能，简单的说，它对进程分组，然后以组为单位进行资源调度和分配，另外还能记录组内进程使用的资源数量（内存、CPU等）。</p>
<h2 id="什么时候要用cgroups"><a href="#什么时候要用cgroups" class="headerlink" title="什么时候要用cgroups"></a>什么时候要用cgroups</h2><p>如果一台机器是给多个人共享，对有些用户，你希望多分配一些资源，对另外一些用户，少分配一些资源，这时候就可以用cgroups。如果你想记录某个用户或者进程一共使用了多少资源，也可以使用cgroups。</p>
<h2 id="直观印象"><a href="#直观印象" class="headerlink" title="直观印象"></a>直观印象</h2><p>下面的例子中，创建两个cgroup foo和bar，给每个组分配不同的cpu优先级。</p>
<p>所有和cgroups的交互都是通过虚拟文件系统完成的，所以我们要挂载cgroup文件系统，像下面的例子这样。</p>
<pre><code>mount -t cgroup -o cpu cgroups /mnt/cgroup # 挂载，-o参数表示加载哪些子系统（参加后面的子系统解释）</code></pre><p>如果执行成功，我们会发现/mnt/cgroup目录下多了几个文件</p>
<pre><code>-rw-r--r-- 1 root root 0 Feb 13 04:19 cpu.rt_period_us
-rw-r--r-- 1 root root 0 Feb 13 04:19 cpu.rt_runtime_us
-rw-r--r-- 1 root root 0 Feb 13 04:19 cpu.shares
-rw-r--r-- 1 root root 0 Feb 13 04:19 notify_on_release
-rw-r--r-- 1 root root 0 Feb 13 04:19 release_agent
-rw-r--r-- 1 root root 0 Feb 13 04:19 tasks</code></pre><p>继续</p>
<pre><code>mkdir /mnt/cgroup/foo
mkdir /mnt/cgroup/bar # 创建了两个cgroup foo和bar

# 设置每个cgroup的参数
echo 100 &gt; /mnt/cgroup/foo/cpu.shares
echo 200 &gt; /mnt/cgroup/bar/cpu.shares</code></pre><p>为了测试，我写了下面一段简单的python代码，保存为loop.py</p>
<pre><code>#!/usr/bin/env python

while True:
    pass</code></pre><p>然后在两个terminal中分别运行loop.py，两个进程分别占用了大约49%的cpu。此时，它们都不在foot和bar cgroup中。</p>
<pre><code>PID  %CPU COMMAND
3722 49.9 python
3723 49.9 python</code></pre><p>下面，把进程放入cgroup，就是简单的pid放入cgroup的task文件中。</p>
<pre><code>echo 3722 &gt; foo/cpu.shares
echo 3723 &gt; bar/cpu.shares </code></pre><p>立刻，cpu使用率改变了。</p>
<pre><code>PID  %CPU COMMAND
3722 65.3 python
3723 32.1 python</code></pre><p>看到了吧，使用cgroup就是这么简单：先挂载，再分组，设置好参数，最后把进程扔到对应的组里就行了。</p>
<p><strong>另外，子进程会自动进入父进程的cgroup中</strong></p>
<h2 id="cgroup的一些概念和名词"><a href="#cgroup的一些概念和名词" class="headerlink" title="cgroup的一些概念和名词"></a>cgroup的一些概念和名词</h2><ul>
<li>任务（task ），就是系统的一个进程。</li>
<li>控制组(control cgroup)，划分出来的一组task集合，包括它们的设置。比如上面的foo，bar都是控制组。</li>
<li>层级(hierarchy) 控制组是有层次的，比如foo下面还可以建新的控制组，新建的控制组自动继承foo的所有配置。</li>
<li>子系统（subsystem），这个最重要了，一个子系统就是一个资源管理器。比如cpu子系统、内存子系统等等。全部的子系统包括blkio, cpu, cpuacct, cpuset, devices, freezer, memory, net_cls, ns等</li>
</ul>
<h2 id="持久化cgroups"><a href="#持久化cgroups" class="headerlink" title="持久化cgroups"></a>持久化cgroups</h2><p>上面例子中的cgroups配置，重启后就消失了，自然不是实用主义做法。如果想配置永久生效，要使用cgconfig服务，把配置写到/etc/cgcfongi.conf文件中。这里就不多做介绍了，毕竟本文也只是个“简介​​​”而已。</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2013/02/03/simple-method-to-test-bandwidth-between-2-machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/02/03/simple-method-to-test-bandwidth-between-2-machine/" class="post-title-link" itemprop="url">测量两台机器间带宽的简单方法</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-02-03 00:00:00" itemprop="dateCreated datePublished" datetime="2013-02-03T00:00:00+08:00">2013-02-03</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:04:22" itemprop="dateModified" datetime="2019-08-03T17:04:22+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>当然能找到各种软件，不过太麻烦了，有没有现成的工具可以直接使用呢？当然有！那就是……nc，一台机器启动nc监听端口，另一台机器启动nc一直发送数据，一段时间后停止，再计算带宽就行了。当前，这里假设nc把带宽占满了，机器负载不大的时候一般没问题。</p>
<p>机器A，启动nc监听端口</p>
<pre><code>nc -l -n 1234|wc -c</code></pre><p>wc -c不能省略，否则没法知道一共收到多少字节。</p>
<p>机器B，启动nc一直发送数据。</p>
<pre><code>time yes | nc -n A_IP 1234 </code></pre><p>一段时间后，在机器B上按下Ctrl+C，用A机器上输出的数字和B机器上输出的时间算出带宽就行了。比如我这里，A上输出 <code>30496256</code>，B上输出 </p>
<pre><code>real    0m1.080s
user    0m0.804s
sys     0m0.699s</code></pre><p>带宽是 30496256 / 1.080 bps </p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oditszapc.com/2012/12/19/http-Keepalive-and-tcp-connections/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiang Jizhong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="姜太公的记事本">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2012/12/19/http-Keepalive-and-tcp-connections/" class="post-title-link" itemprop="url">Http Keepalive和TCP连接数</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2012-12-19 00:00:00" itemprop="dateCreated datePublished" datetime="2012-12-19T00:00:00+08:00">2012-12-19</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-08-03 17:04:12" itemprop="dateModified" datetime="2019-08-03T17:04:12+08:00">2019-08-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>Http Keepalive和TCP连接数是两个完全不同的东西，之所以要放在一起说，因为是前段时间遇到了<code>TIME_WAIT</code>状态的连接数过高，运维人员说是Apache的Keepalive时间太短，当时觉得不合理，仔细思考了下，果然不合理。</p>
<h2 id="Keepalive"><a href="#Keepalive" class="headerlink" title="Keepalive"></a>Keepalive</h2><p>首先简单的介绍下Keepalive，权当是凑字数。Http作为应用层协议，绝大多数时候，它都使用TCP作为传输层协议。众所周知，TCP协议需要三次握手建立连接，需要1.5个RTT，如果网络比较差，加上丢包和重传，需要更多的时间。通常请求一张html页面，其中包含了很多资源，有css、js、图片等，每个文件都不大，建立TCP连接的时间甚至比传输时间还长，太不划算。于是就有了Keepalive：既然每次建立连接太浪费时间，那么就用一个持久连接，每次都用这个连接请求新资源。事实证明，这个策略非常正确，页面加载明显变快，用户体验一下子就上来了.</p>
<p>不过Keepalive也不是完美无缺的。浏览器非常自私，不到迫不得已，它从来不主动关闭连接，毕竟关闭连接下次有请求就要重新打开，对用户来说就感觉这个浏览器慢，在浏览器竞争如此激烈的今天，哪个浏览器会干这种事呢。所以，不要指望浏览器会主动关闭连接（当然，浏览器如果觉得自己的同时打开的连接太多了，它也会关掉一些，开这么多连接对自己也是个负担，所以要关掉。说到底，浏览器是自私的）。服务器一般支持keepalive timeout之类的，如果客户端一段时间内没有发送新请求，服务器就把对应的TCP连接关掉。</p>
<p><em>从上面的描述也可以看出来，如果不存在同一个连接请求多个资源的场景，服务器应该关闭Keepalive</em></p>
<h2 id="关闭连接和TCP状态"><a href="#关闭连接和TCP状态" class="headerlink" title="关闭连接和TCP状态"></a>关闭连接和TCP状态</h2><p>大部分都知道TCP建立连接需要三步（三次握手），关闭连接需要四步。关闭连接的时候，发起关闭的一方为“主动关闭”，另一方为被动关闭。过程和状态是这样的：</p>
<pre><code>A                             B                                                                                                           
-------------FIN--------------&gt;                                                                                                           
FIN_WAIT1                                                                                                                                 
&lt;------------ACK---------------                                                                                                           
FIN_WAIT2            CLOSE_WAIT
&lt;------------FIN---------------
TIME_WAIT              LAST_ACK
------------ACK---------------&gt;
TIME_WAIT                CLOSED
.
.
.
2MSL (2 * Max Segment Lifetime)
.
.
.
CLOSED</code></pre><p>上面的图里，A是主动关闭，进入<code>TIME_WAIT</code>状态，B是被动关闭，进入<code>CLOSE_WAIT</code>状态。根据第一段的描述，服务器是主动关闭的一方，进入<code>TIME_WAIT</code>状态，客户端是被动关闭的一方，进入<code>CLOSE_WAIT</code>状态。</p>
<p><em>主动关闭为什么发送了最后一个ACK还要等待2MSL才真正关闭连接呢？假设最后的ACK包丢了，没传到B，B会怎么样？根据TCP协议，B会一直等待并且重传上一个FIN。A等2MSL是为了尽量保证最后的ACK已经送达B。</em></p>
<h2 id="Keepalive-Timeout和连接数"><a href="#Keepalive-Timeout和连接数" class="headerlink" title="Keepalive Timeout和连接数"></a>Keepalive Timeout和连接数</h2><p>那么，Keepalive time会如何影响连接数呢？不妨建立一个简单的模型：服务器匀速接收到连接，每秒10个，每个连接只发送一次请求，5s时间后关闭。2MSL=3 (<code>cat /proc/sys/net/ipv4/tcp_fin_timeout</code>可以看到机器上的值)</p>
<pre><code>时间            0   1   2   3   4   5   6   7   8   9   10  11
ESTABLISHED     0   10  20  30  40  50  50  50  50  50  50  50
TIME_WAIT       0   0   0   0   0   0   10  20  30  30  30  30</code></pre><p>在0-1秒，建立了10个连接，没有连接关闭，1-2秒，又建立了10个连接，没有连接关闭……在第6秒，0-1秒建立的连接超时关闭了，出现10个<code>TIME_WAIT</code>状态的连接，同时有10个新连接建立，所以ESTABLISHED状态的连接还是50个，<code>TIME_WAIT</code>状态的连接10个……到第9秒，10个<code>TIME_WAIT</code>状态的连接彻底关闭，同时产生10个新的<code>TIME_WAIT</code>，<code>TIME_WAIT</code>状态的连接还是30个。在这个模型中：keepalive只影响了ESTABLISHED状态连接，不影响<code>TIME_WAIT</code>状态的连接，2MSL只影向<code>TIME_WAIT</code>状态的连接，不影响ESTABLISHED状态的连接。</p>
<p>还是上面的模型，延长keepalive时间为6s，连接数变化如下。</p>
<pre><code>时间            0   1   2   3   4   5   6   7   8   9   10  11
ESTABLISHED     0   10  20  30  40  50  60  60  60  60  60  60
TIME_WAIT       0   0   0   0   0   0   0   10  10  10  10  10</code></pre><p>虽然这是一个简化的模型，但是结论是没问题的，有兴趣的同学可以考虑变化的连接速度和更精细的时间。这里只说最终结论：<strong>keepalive只影响ESTABLISHED状态的最大数量，同样条件下，keepalive越大，ESTABLISHED最大值就越大。同样条件下，2MSL越大，TIME_WAIT最大值就越大</strong></p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jiang Jizhong</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/zjZSTU" title="Github &rarr; https://github.com/zjZSTU" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>Github</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://blog.csdn.net/u012005313" title="CSDN &rarr; https://blog.csdn.net/u012005313" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>CSDN</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:zjzstu@gmail.com" title="Email &rarr; mailto:zjzstu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>Email</a>
      </span>
    
  </div>



        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiang Jizhong</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



  

  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  


































</body>
</html>
